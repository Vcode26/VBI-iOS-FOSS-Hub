<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebClip Generator</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 5px; }
    button { margin-top: 20px; }
    pre { background: #f4f4f4; padding: 15px; white-space: pre-wrap; }

    #successBanner {
      display: none;
      background: #28a745;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    #successBanner.show {
      display: block;
      opacity: 1;
    }
  </style>
</head>
<body>

  <h1>WebClip Generator</h1>

  <label>Name</label>
  <input id="name" type="text" placeholder="Viaan">

  <label>URL</label>
  <input id="url" type="text" placeholder="https://example.com">

  <label>Icon (Upload File)</label>
  <input id="iconFile" type="file" accept="image/*">

  <label>Icon (Base64 Output)</label>
  <textarea id="icon" placeholder="Base64 will appear here automatically"></textarea>

  <label>Fullscreen</label>
  <input id="fullscreen" type="checkbox">

  <label>Filename</label>
  <input id="filename" type="text" placeholder="com.example.webclip">

  <button onclick="generate()">Generate Mobileconfig JSON</button>
  <button onclick="downloadConfig()">Download .mobileconfig</button>
  <button onclick="publish()"> &lt;publish to VBI iOS FOSS Hub&gt; </button>

  <div id="successBanner">✓ Successfully uploaded to GitHub</div>

  <h2>Output</h2>
  <pre id="output"></pre>

<script>
/* ------------------------------
   FILE → BASE64
--------------------------------*/
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(",")[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.getElementById("iconFile").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const base64 = await fileToBase64(file);
  document.getElementById("icon").value = base64;
});

/* ------------------------------
   UUID GENERATOR
--------------------------------*/
function generateUUID() {
  return crypto.randomUUID();
}

/* ------------------------------
   BUILD PAYLOAD (XML + filename)
--------------------------------*/
function buildPayload() {
  const name = document.getElementById("name").value.trim();
  const url = document.getElementById("url").value.trim();
  const icon = document.getElementById("icon").value.trim();
  const fullscreen = document.getElementById("fullscreen").checked;
  const filename = document.getElementById("filename").value.trim();

  const uuid1 = generateUUID();
  const uuid2 = generateUUID();

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>PayloadContent</key>
  <array>
    <dict>
      <key>FullScreen</key>
      ${fullscreen ? "<true/>" : "<false/>"}
      <key>Icon</key>
      <data>${icon}</data>
      <key>Label</key>
      <string>${name}</string>
      <key>PayloadIdentifier</key>
      <string>com.webclip.${name}.${uuid1}</string>
      <key>PayloadType</key>
      <string>com.apple.webClip.managed</string>
      <key>PayloadUUID</key>
      <string>${uuid1}</string>
      <key>PayloadVersion</key>
      <integer>1</integer>
      <key>URL</key>
      <string>${url}</string>
    </dict>
  </array>

  <key>PayloadDisplayName</key>
  <string>${name} WebClip</string>
  <key>PayloadIdentifier</key>
  <string>com.webclip.${name}.profile</string>
  <key>PayloadType</key>
  <string>Configuration</string>
  <key>PayloadUUID</key>
  <string>${uuid2}</string>
  <key>PayloadVersion</key>
  <integer>1</integer>
</dict>
</plist>`;

  return { xml, filename };
}

/* ------------------------------
   GENERATE JSON PREVIEW
--------------------------------*/
function generate() {
  const payload = buildPayload();
  document.getElementById("output").textContent = JSON.stringify(payload, null, 2);
}

/* ------------------------------
   DOWNLOAD .mobileconfig
--------------------------------*/
function downloadConfig() {
  const { xml, filename } = buildPayload();

  const blob = new Blob([xml], { type: "application/x-apple-aspen-config" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename + ".mobileconfig";
  a.click();

  URL.revokeObjectURL(url);
}

/* ------------------------------
   DIRECT UPLOAD TO GITHUB
--------------------------------*/
async function publish() {
  const { xml, filename } = buildPayload();

  const token = "YOUR_FINE_GRAINED_TOKEN_HERE";

  // GitHub requires Base64 for file uploads
  const contentBase64 = btoa(unescape(encodeURIComponent(xml)));

  const path = `${filename}.mobileconfig`;

  const res = await fetch(
    `https://api.github.com/repos/Vcode26/VBI-iOS-FOSS-Hub/contents/${path}`,
    {
      method: "PUT",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Add mobileconfig: ${filename}`,
        content: contentBase64
      })
    }
  );

  const data = await res.json();

  if (res.status === 201 || res.status === 200) {
    const banner = document.getElementById("successBanner");
    banner.style.display = "block";
    banner.classList.add("show");

    setTimeout(() => {
      banner.classList.remove("show");
      setTimeout(() => banner.style.display = "none", 400);
    }, 4000);
  } else {
    alert("GitHub error: " + res.status + " — " + JSON.stringify(data));
  }
}
</script>

</body>
</html>
